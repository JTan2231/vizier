# Copy this file to ~/.config/vizier/config.toml for user-wide settings or to .vizier/config.toml so the repo carries its defaults. When no --config-file is provided, Vizier loads the global config first (if it exists) and overlays .vizier/config.toml so repo entries override while missing keys inherit your personal defaults; VIZIER_CONFIG_FILE is only used when neither config file is present. See docs/user/config-reference.md for the full catalogue of keys, defaults, and CLI overrides.
# Global defaults (apply unless overridden below)
agent = "codex"
# Commands fail fast when the selected agent shim is unavailable; there is no fallback toggle.
# Supported selectors: bundled `codex`/`gemini` or any custom shim name present under share/vizier/agents/.
# Agent runs default to wrapped JSON handling: the exec command should stream JSON to stdout, Vizier tees it through an optional progress filter for stderr, and the final assistant text is extracted for stdout. Set output="passthrough" for legacy scripts that already split stdout/stderr. Bundled shims install under `share/vizier/agents/`; pick them via the selector above or override the runtime command per scope.

# Example: route every command alias through your own script. Update the `[agents.default]` entry below (or
# whichever aliases/templates you care about) so `agent = "custom"` and then uncomment this block to point
# Vizier at your script.
# [agents.default.agent]
# command = ["/usr/local/share/vizier/agents/codex/agent.sh"] # Or point directly at your script
# output = "auto"                    # auto|wrapped-json; auto wraps bundled shims
# progress_filter = ["./examples/agents/codex/filter.sh"] # Optional progress-to-stderr filter; defaults when selector=codex
# Command aliases inherit this runner; swap to another script by updating these fields (or an alias table like `[agents.commands.review.agent]`).

# Prompt profiles live under [agents.commands.<alias>.prompts.<kind>] (or [agents.templates."<selector>".prompts.<kind>]); each entry ties prompt text (inline or via `path`)
# together with agent overrides for that scope+prompt pairing. Available kinds: documentation, commit,
# implementation_plan, review, merge_conflict. See `docs/user/prompt-config-matrix.md` for the full scope√óprompt-kind
# matrix, fallback order, and documentation toggles.
[agents.default.prompts.documentation]
path = "./prompts/documentation.md"

[agents.commands.draft.prompts.implementation_plan]
path = "./prompts/plan.md"
agent = "codex"

[agents.commands.review.prompts.review]
path = "./prompts/review.md"
agent = "codex"

# Order of operations the configured agent will run during `vizier review` unless `--skip-checks` is passed
[review.checks]
commands = [
  "cargo fmt -- --check",
  "cargo clippy -- -D warnings",
  "cargo test --all --all-targets"
]

# Default merge behavior (per-plan history will be [implementation commit, merge commit])
[merge]
# When true, Vizier squashes implementation commits before creating the merge commit.
squash = true
# Optional default mainline parent (1-based) when squashing plan branches that contain merge commits.
# squash_mainline = 2

# Default conflict-handling behavior for vizier merge (overridden by --auto-resolve-conflicts/--no-auto-resolve-conflicts)
[merge.conflicts]
auto_resolve = true

# Optional CI/CD gate script run during `vizier merge` (auto_resolve here controls gate remediation, not conflict handling)
[merge.cicd_gate]
script = "./cicd.sh"
auto_resolve = true
retries = 2

# Build orchestration defaults for `vizier build execute`
[build]
default_pipeline = "approve-review"
default_merge_target = "primary"
stage_barrier = "strict"
failure_mode = "block_downstream"
default_review_mode = "apply_fixes"
default_skip_checks = false
default_keep_draft_branch = false
default_profile = "integration"

[build.profiles.integration]
pipeline = "approve-review-merge"
merge_target = "build"
review_mode = "review_only"
skip_checks = true
keep_branch = true

# Commit metadata controls (defaults shown)
[commits.meta]
enabled = true
style = "header" # header|trailers|both|none
include = ["session_id", "session_log", "author_note", "narrative_summary"]
session_log_path = "relative" # relative|absolute|none

[commits.meta.labels]
session_id = "Session ID"
session_log = "Session Log"
author_note = "Author note"
narrative_summary = "Narrative updates"

[commits.fallback_subjects]
code_change = "VIZIER CODE CHANGE"
narrative_change = "VIZIER NARRATIVE CHANGE"
conversation = "VIZIER CONVERSATION"

[commits.implementation]
subject = "feat: apply plan {slug}"
fields = ["Target branch", "Plan branch", "Summary"]

[commits.merge]
subject = "feat: merge plan {slug}"
include_operator_note = true
operator_note_label = "Operator Note"
plan_mode = "full" # full|summary|none
plan_label = "Implementation Plan"

# List output formatting (defaults shown)
[display.lists.list]
format = "block" # block|table|json
header_fields = ["Outcome", "Target"]
entry_fields = ["Plan", "Branch", "Summary"]
job_fields = ["Job", "Job status", "Job scope", "Job started"]
command_fields = ["Status", "Logs", "Attach"]
summary_max_len = 120
summary_single_line = true

[display.lists.jobs]
format = "block" # block|table|json
show_succeeded = false
fields = [
  "Job",
  "Status",
  "Created",
  "Wait",
  "Waited on",
  "After",
  "Dependencies",
  "Locks",
  "Pinned head",
  "Artifacts",
  "Failed",
  "Command",
]

[display.lists.jobs_show]
format = "block" # block|table|json
fields = [
  "Job",
  "Status",
  "PID",
  "Started",
  "Finished",
  "Exit code",
  "Stdout",
  "Stderr",
  "Session",
  "Outcome",
  "Scope",
  "Plan",
  "Target",
  "Branch",
  "Build pipeline",
  "Build target",
  "Build review mode",
  "Build skip checks",
  "Build keep branch",
  "Build dependencies",
  "Workflow template",
  "Workflow template version",
  "Workflow node",
  "Workflow policy snapshot",
  "Workflow gates",
  "Patch file",
  "Patch index",
  "Patch total",
  "Revision",
  "After",
  "Dependencies",
  "Locks",
  "Wait",
  "Waited on",
  "Pinned head",
  "Artifacts",
  "Worktree",
  "Worktree name",
  "Agent backend",
  "Agent label",
  "Agent command",
  "Agent exit",
  "Cancel cleanup",
  "Cancel cleanup error",
  "Config snapshot",
  "Command"
]

# Optional stop-condition for `vizier approve`: when configured, the agent is re-run on the draft branch until this script exits 0 or the retry budget is exhausted.
# [approve.stop_condition]
# script = "./scripts/approve-stop.sh"
# retries = 3

# Global workflow defaults (apply unless CLI overrides them)
[workflow]
# When true, assistant-backed commands hold their edits for manual commits until you rerun without --no-commit.
no_commit_default = false

[workflow.background]
# Default assistant-backed commands to background jobs (disable to force foreground)
enabled = true
# Silence progress chatter for detached jobs unless the caller set verbosity
quiet = true

# Optional workflow-template mapping used when scheduler jobs are compiled from wrapper commands.
# `[commands]` is the new primary surface; `[workflow.templates]` remains as compatibility fallback.
[commands]
save = "template.save.v1"
draft = "template.draft.v1"
approve = "template.approve.v1"
review = "template.review.v1"
merge = "template.merge.v1"
build_execute = "template.build_execute.v1"
patch = "template.patch.v1"

[workflow.templates]
save = "template.save.v1"
draft = "template.draft.v1"
approve = "template.approve.v1"
review = "template.review.v1"
merge = "template.merge.v1"
build_execute = "template.build_execute.v1"
patch = "template.patch.v1"

# Optional cleanup for cancelled background jobs (never runs on failures)
[jobs.cancel]
cleanup_worktree = false

# Default agent stack inherited by every command before CLI flags are processed
[agents.default]
agent = "codex"

# Example: route review through Gemini instead of Codex via a script shim
# [agents.commands.review]
# agent = "gemini"
# [agents.commands.review.agent]
# command = ["./examples/agents/gemini/agent.sh"]

# Keep save flows on the codex stack so narrative edits always use the same selector
[agents.commands.save]
agent = "codex"

# The remaining plan workflow commands stay on the codex stack and inherit the defaults
[agents.commands.draft]
agent = "codex"

[agents.commands.approve]
agent = "codex"

[agents.commands.review]
agent = "codex"

# Allow merge-time agents to skip documentation prompt + narrative context when auto-resolving conflicts
[agents.commands.merge.documentation]
enabled = false
include_snapshot = false
include_narrative_docs = false

[agents.commands.merge]
agent = "codex"
