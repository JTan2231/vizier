id = "template.stage.approve"
version = "v2"

[cli]
positional = ["slug", "branch"]

[cli.named]
name = "slug"

[params]
branch = ""
commit_message = "chore: workflow stage commit"
slug = ""
stop_condition_retries = "3"
stop_condition_script = ""

[[artifact_contracts]]
id = "prompt_text"
version = "v1"

[[nodes]]
id = "worktree_prepare"
kind = "builtin"
uses = "cap.env.builtin.worktree.prepare"

[nodes.args]
branch = "${branch}"
slug = "${slug}"
purpose = "stage-approve"

[nodes.on]
succeeded = ["resolve_prompt"]

[[nodes]]
id = "resolve_prompt"
kind = "builtin"
uses = "cap.env.builtin.prompt.resolve"

[nodes.args]
prompt_file = ".vizier/prompts/APPROVE_PROMPTS.md"

[nodes.produces]
succeeded = [{ custom = { type_id = "prompt_text", key = "approve_main" } }]

[nodes.on]
succeeded = ["invoke_agent"]

[[nodes.after]]
node_id = "worktree_prepare"

[[nodes]]
id = "invoke_agent"
kind = "agent"
uses = "cap.agent.invoke"

[[nodes.needs]]
custom = { type_id = "prompt_text", key = "approve_main" }

[nodes.on]
succeeded = ["stage_commit"]

[[nodes.after]]
node_id = "resolve_prompt"

[[nodes]]
id = "stage_commit"
kind = "builtin"
uses = "cap.env.builtin.git.stage_commit"

[nodes.args]
message = "${commit_message}"

[[nodes.after]]
node_id = "invoke_agent"

[nodes.on]
succeeded = ["stop_gate"]

[[nodes]]
id = "stop_gate"
kind = "gate"
uses = "control.gate.stop_condition"

[[nodes.gates]]
kind = "script"
script = "${stop_condition_script}"
policy = "retry"

[nodes.retry]
mode = "until_gate"
budget = "${stop_condition_retries}"

[[nodes.after]]
node_id = "stage_commit"

[nodes.on]
succeeded = ["worktree_cleanup"]
failed = ["stage_commit"]

[[nodes]]
id = "worktree_cleanup"
kind = "builtin"
uses = "cap.env.builtin.worktree.cleanup"

[nodes.on]
succeeded = ["terminal"]

[[nodes.after]]
node_id = "stop_gate"

[[nodes]]
id = "terminal"
kind = "gate"
uses = "control.terminal"

[[nodes.after]]
node_id = "worktree_cleanup"
