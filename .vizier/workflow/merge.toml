id = "template.stage.merge"
version = "v2"

[params]
branch = ""
cicd_auto_resolve = "false"
cicd_auto_resolve_script = ""
cicd_script = ""
conflict_auto_resolve = "false"
delete_branch = "true"
merge_message = ""
slug = ""
squash = "true"
target_branch = ""

[[nodes]]
id = "merge_integrate"
kind = "builtin"
uses = "cap.env.builtin.git.integrate_plan_branch"

[nodes.args]
branch = "${branch}"
delete_branch = "${delete_branch}"
message = "${merge_message}"
slug = "${slug}"
squash = "${squash}"
target_branch = "${target_branch}"

[nodes.on]
succeeded = ["merge_gate_cicd"]
blocked = ["merge_conflict_resolution"]

[[nodes]]
id = "merge_conflict_resolution"
kind = "gate"
uses = "control.gate.conflict_resolution"

[nodes.args]
auto_resolve = "${conflict_auto_resolve}"
slug = "${slug}"

[nodes.on]
succeeded = ["merge_integrate"]

[[nodes]]
id = "merge_gate_cicd"
kind = "gate"
uses = "control.gate.cicd"

[nodes.args]
auto_resolve = "${cicd_auto_resolve}"
auto_resolve_script = "${cicd_auto_resolve_script}"

[[nodes.gates]]
kind = "cicd"
script = "${cicd_script}"
auto_resolve = false
policy = "retry"

[nodes.on]
succeeded = ["terminal"]

[[nodes]]
id = "terminal"
kind = "gate"
uses = "control.terminal"
