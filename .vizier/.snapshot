Running Snapshot — updated

Narrative theme
- Reduce operator friction: conversational intent is authorization to evolve the project. The assistant maintains a living snapshot and task list by default; users can explicitly opt out per turn.
- Editorial housekeeping: Canonicalize duplicated TODO artifacts so each thread has a single authoritative TODO with cross-links; add TODO garbage-collection during save to keep the garden clean.
- Codex-integrated posture: Codex now handles the heavy agent work directly, so Vizier trims internal orchestration threads and focuses on snapshot accuracy plus CLI guardrails.
- Lean backlog: Threads that do not protect Codex-era workflows were culled; the remaining arcs prioritize IO contracts, auditability, and documentation gates.
- Bureaucratic enforcement: Treat Vizier as the compliance enforcer for large-organization processes (architecture docs per change, auditable histories, PR-ready artifacts).

Active threads
- Stdout/stderr contract + verbosity: ACTIVE. Enforce TTY-gated progress, -q/-v/-vv levers, and a stable stdout Outcome line or JSON (outcome.v1). Stderr stays reserved for progress/errors per verbosity; no ANSI in non-TTY contexts. [Cross: Outcome summaries]
- Mode split: Chat (default) vs Protocol Mode v1: ACTIVE. Chat remains human-first with readable epilogues; Protocol mode is machine-first with structured JSON/NDJSON on stdout, no ANSI, deterministic ordering, and categorized exit codes. `--mode protocol` toggles behavior; JSON stream shares the same event contract as chat. [Cross: Stdout/stderr, Outcome summaries]
- Commit isolation + gates: ACTIVE. Conversation- and agent-sourced changes are staged behind a Pending Commit gate; chat flows must funnel through the Auditor before commits land. [Depends on: Outcome summaries, Session logging]
- Default-Action Posture (DAP): ACTIVE. By default, snapshot and TODOs update on any directive unless the user opts out (e.g., “discuss-only”). CLI surfaces a one-line Outcome whenever DAP acts. [Cross: Outcome summaries]
- Outcome summaries: ACTIVE. A unified human epilogue and outcome.v1 JSON must reflect Auditor A/M/D/R facts and gate state after every action. [Depends on: Auditor]
- Architecture doc gate + compliance: ACTIVE. Every code change needs an attached architecture doc logged in commit history; Vizier enforces creation, storage, and linkage before merges or saves. [Depends on: Outcome summaries, Commit isolation/gates]
- Session logging to filesystem: ACTIVE, BLOCKED UNTIL WIRING. Chat sessions are not yet persisted; add a session writer at chat boundaries to save audited facts + workflow metadata. [Depends on: Auditor facts, Outcome]
- TODO Garbage-Collection on save: ACTIVE. Vizier aggressively removes duplicate, superseded, empty, and orphaned TODOs during `vizier save` and after material TODO merges, with safety levers and clear Outcome reporting. [Depends on: Config, Auditor, VCS, file tracking, Snapshot Threads]
- Agent workflow orchestration: NEW. Operators want Vizier to act as the conductor for multi-agent runs (snapshot wording sign-off → architecture doc draft → implementation → code sign-off → `vizier save`), so the CLI/Auditor stack must expose those checkpoints and keep the VCS gates tight. [Cross: Commit isolation, Architecture doc gate, Outcome summaries]

Code state (behaviors that matter)
- CLI emits transient spinner/status to stderr via vizier-core::display with ANSI cursor controls unconditionally, causing leaked sequences like "[1G\u001b[2K⠋ Thinking..." in logs and non-TTY contexts.
- stdout is inconsistently used; many operations primarily talk via stderr (status) and have no stable stdout outcome line.
- No verbosity controls beyond a debug flag; no quiet mode; no progress/ANSI gating by TTY.
- No explicit mode switch exists; protocol-style behavior is not yet implemented. JSON stream/eventing is planned.
- No vizier-tui crate present; CLI + vizier-core surfaces (display/chat) are the user-facing paths in this repo.
- Chat path now routes through the Auditor; diffs from chat-initiated changes can be reported with A/M/D/R. Session JSON logging is not wired yet.
- Post-action UX lacks a unified Outcome section; assistant epilogues can be verbose/misaligned, but Auditor facts for chat are available to drive a canonical epilogue. Outcome component targeted CLI-first with outcome.v1 JSON and stdout epilogue. Canonical TODO added.
- No built-in agent command: Vizier intentionally lacks a `vizier agent run` flow; operators launch Codex directly and handle branch/PR plumbing outside the CLI.
- AGENTS.md contract/log: The file remains a short reminder pointing agents back to README + snapshot; there is no in-repo decision log or interop schema beyond that note.
- TODO GC not yet implemented; policy and levers defined; to be wired into save path and Auditor Outcome.
- Codex backend path now lives in `vizier-core/src/codex.rs`: the auditor spawns `codex exec --json --output-last-message` in the repo, streams progress events, captures token usage, falls back to the wire backend when Codex errors, and CODEX.md serves as the living rollout log for this flow.
- Auditor commit plumbing now calls `FileTracker::sync_vizier_changes` before writing `.vizier` commits and returns early when nothing changed so Codex-edited snapshot/TODO files get staged without disturbing pre-existing staged code.
- `vizier-cli` appends `(tokens: prompt=?, completion=?, total=?)` (or `unknown`) to the assistant summary line so token reporting is visible even when Codex supplies usage counts.
- Architecture doc compliance: no docs/architecture index exists and saves succeed without citing a doc, so there is no auditable linkage from code changes to architecture intent.
- `vizier draft` provisions a `draft/<slug>` branch from the primary branch tip via a temporary worktree, runs Codex to generate `.vizier/implementation-plans/<slug>.md`, commits the plan on that branch, then cleans up the worktree so the operator’s checkout stays untouched while stdout reports the plan path/branch pairing.
- Multi-agent workflows are ad-hoc: there is no structured runbook that walks operators through “discuss → snapshot sign-off → architecture doc draft → implement → code sign-off → save,” so intent can drift between agents and VCS gates.

Acceptance checkpoints (selected)
- Stdout/stderr contract: Non-TTY emits no ANSI; stdout carries final results; stderr stays limited to errors/warnings unless verbose. Flags -q/-v/-vv implemented; JSON modes obey schema outcome.v1. [Active]
- Mode split: `--mode protocol` produces only structured JSON/NDJSON on stdout (no human prose), no ANSI in any environment, deterministic event ordering, and categorized exit codes. Chat mode remains default with human epilogue and optional `--json`/`--json-stream`. Closed-stdin never blocks. [Active]
- Pending Commit gate guards conversation changes with confirm_destructive=true and auto_commit=false.
- Conversation commits only touch .vizier; preserve pre-existing staged changes exactly (A/M/D/R).
- Non-interactive CLI requires explicit consent; never opens editor.
- Session JSON MVP: session.json written atomically at session end, validating schema; includes workflow_type and thinking_level. [Pending; not yet saving]
- Outcome summaries: After each operation, users see a compact summary matching Auditor/VCS facts; assistant final mirrors it. For chat, the Auditor-backed A/M/D/R must be reflected in both human epilogue and outcome.v1 JSON. Deterministic final Outcome emission. [CLI-first]
- TODO GC on save: During `vizier save`, duplicate/superseded/empty/orphaned TODOs are deleted or staged for deletion per config; Outcome reports deletions with reasons; dry-run supported; protected items skipped. [Active]
- Architecture doc gate: Saves refuse to finalize without a cited architecture doc; outcomes and commits include the referenced path, and multi-agent runs share the same doc reference. [Planned]

Next moves
1) Stdout/stderr contract + verbosity: introduce -q/-v/-vv, progress/ANSI gating by TTY, and ensure stdout carries final results/outcomes; refactor vizier-core::display accordingly. [Active]
2) Outcome component: implement outcome.v1 schema; include audited A/M/D/R, gate state, and (when applicable) {todo, branch, commit_count, pr_url}. Print to stdout on success; `--json` and `--json-stream` variants. Ensure it fires after every chat operation. [Active]
3) Mode split wiring: Add `--mode protocol` to CLI, thread through to core display/observer; enforce protocol-mode IO rules, exit codes, and metadata {mode:"protocol"}. Ensure closed-stdin safe behavior. [Active]
4) Chat gate parity: keep chat-initiated edits behind the Auditor and Pending Commit gate, mirroring `ask`, and surface results via Outcome/JSON plus optional commits. [Active]
5) TODO GC wiring: Add product-level GC behavior into save path with config/flags; surface detailed Outcome facts and integrate with Pending Commit gate where enabled. [Active]
6) Session logging JSON MVP: hook writer at chat boundaries to persist audited facts + workflow metadata; atomic write + schema validation; include path in Outcome epilogue and JSON. [Active]
7) Architecture doc enforcement + history: Add compliance gates that require architecture docs for every code change, store doc references alongside commits, and surface discrepancies via Auditor/Outcome before merge. [New]
8) Agent workflow orchestration: Give operators a first-class workflow that sequences snapshot approval, architecture doc drafting, implementation, code sign-off, and final `vizier save`, with Auditor/Outcome breadcrumbs for each checkpoint. [New]
9) Draft approval plumbing: follow `vizier draft` with a `vizier approve <plan>` flow that reads plan metadata, verifies reviewer sign-off, and fast-forwards the draft branch (and plan status) back onto the primary branch with proper Outcome reporting. [Planned]

Cross-links
- Output contract + Mode split ↔ Outcome summaries: the same event stream feeds human epilogues, protocol JSON, and chat results without ANSI leakage.
- DAP ↔ Outcome ↔ TODO GC: default-action edits update .vizier, GC keeps the garden tidy, and the Outcome line reports those edits.
- Commit isolation + gates ↔ Architecture doc compliance: pending commits and save gates must cite the architecture doc reference and surface it in outcomes/commits.
- Session logging ↔ Auditor facts: chat operations persist audited facts to session.json, and the Outcome epilogue points to the artifact for downstream tooling.
- Agent workflows ↔ Commit/Doc gates: the same checkpoints that gate architecture docs and pending commits must be surfaced as workflow steps so multi-agent runs stay aligned and auditable.
